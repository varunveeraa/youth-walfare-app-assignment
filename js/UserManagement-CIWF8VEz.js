import{r as b,c as N,j as we,a as f,b as e,f as $,v as V,E as ie,u as n,G as se,z as le,g as _,t as c,i as Ue,F as de,D as ce,y as K,o as y}from"./vendor-BmZR9K5F.js";import{n as ae,D as Ce,G as ue,z as _e,A as Ae,x as Se,B as xe}from"./firebase-w6XYyoFK.js";import{d as G,_ as De,b as Ee}from"./index-csEBr71G.js";import{C as J}from"./collections-BIJkFGz0.js";import"./mapbox-Dy2hBtBs.js";const ke=()=>{const U=b(!1),v=b(null),u=b([]),x=b(0),h=b(1),m=b(10),C=b(""),p=b("createdAt"),A=b("desc"),S=b(""),E=N(()=>Math.ceil(x.value/m.value)),D=N(()=>{let l=[...u.value];if(C.value){const o=C.value.toLowerCase();l=l.filter(d=>d.displayName?.toLowerCase().includes(o)||d.email?.toLowerCase().includes(o)||d.role?.toLowerCase().includes(o))}return S.value&&(l=l.filter(o=>o.role===S.value)),l.sort((o,d)=>{let i=o[p.value],r=d[p.value];return p.value==="createdAt"||p.value==="lastLoginAt"?(i=i?new Date(i.seconds*1e3):new Date(0),r=r?new Date(r.seconds*1e3):new Date(0)):typeof i=="string"&&(i=i.toLowerCase(),r=r?.toLowerCase()||""),A.value==="asc"?i>r?1:-1:i<r?1:-1}),l}),R=N(()=>{const l=(h.value-1)*m.value,o=l+m.value;return D.value.slice(l,o)}),T=async(l=1)=>{U.value=!0,v.value=null;try{console.log("Fetching users for page:",l);const o=_e(G,J.USERS),d=Ae(o,Se("createdAt","desc")),i=await xe(d),r=[];i.forEach(L=>{const B=L.data();r.push({id:L.id,...B,status:F(B),lastActive:w(B.lastLoginAt)})}),u.value=r,x.value=r.length,h.value=l,console.log(`Fetched ${r.length} users`)}catch(o){console.error("Error fetching users:",o),v.value=o.message}finally{U.value=!1}},Q=async(l,o)=>{U.value=!0,v.value=null;try{console.log("Updating user role:",l,o);const d=ae(G,J.USERS,l);await ue(d,{role:o,updatedAt:new Date});const i=u.value.findIndex(r=>r.id===l);return i!==-1&&(u.value[i].role=o,u.value[i].updatedAt=new Date),console.log("User role updated successfully"),{success:!0,message:"User role updated successfully"}}catch(d){return console.error("Error updating user role:",d),v.value=d.message,{success:!1,message:d.message}}finally{U.value=!1}},H=async(l,o)=>{U.value=!0,v.value=null;try{console.log("Toggling user status:",l,o);const d=ae(G,J.USERS,l);await ue(d,{isActive:o,updatedAt:new Date});const i=u.value.findIndex(r=>r.id===l);return i!==-1&&(u.value[i].isActive=o,u.value[i].updatedAt=new Date,u.value[i].status=F(u.value[i])),console.log("User status updated successfully"),{success:!0,message:"User status updated successfully"}}catch(d){return console.error("Error updating user status:",d),v.value=d.message,{success:!1,message:d.message}}finally{U.value=!1}},W=async l=>{U.value=!0,v.value=null;try{console.log("Deleting user:",l);const o=ae(G,J.USERS,l);return await Ce(o),u.value=u.value.filter(d=>d.id!==l),x.value=u.value.length,console.log("User deleted successfully"),{success:!0,message:"User deleted successfully"}}catch(o){return console.error("Error deleting user:",o),v.value=o.message,{success:!1,message:o.message}}finally{U.value=!1}},X=l=>{C.value=l,h.value=1},Z=l=>{S.value=l,h.value=1},ee=(l,o=null)=>{p.value===l&&!o?A.value=A.value==="asc"?"desc":"asc":(p.value=l,A.value=o||"asc"),h.value=1},k=l=>{l>=1&&l<=E.value&&(h.value=l)},I=()=>{try{const l=P(D.value);return q(l,"mindbridge-users.csv"),{success:!0,message:"Users exported successfully"}}catch(l){return console.error("Error exporting users:",l),{success:!1,message:l.message}}},F=l=>{if(l.isActive===!1)return"Inactive";if(l.lastLoginAt){const o=new Date(l.lastLoginAt.seconds*1e3),d=(Date.now()-o.getTime())/(1e3*60*60*24);if(d>30)return"Dormant";if(d>7)return"Inactive"}return"Active"},w=l=>{if(!l)return"Never";const o=new Date(l.seconds*1e3),i=new Date-o,r=Math.floor(i/(1e3*60*60*24));return r===0?"Today":r===1?"Yesterday":r<7?`${r} days ago`:r<30?`${Math.floor(r/7)} weeks ago`:`${Math.floor(r/30)} months ago`},P=l=>{const o=["Name","Email","Role","Status","Join Date","Last Active"],d=l.map(r=>[r.displayName||"",r.email||"",r.role||"",r.status||"",r.createdAt?new Date(r.createdAt.seconds*1e3).toLocaleDateString():"",r.lastActive||""]);return[o,...d].map(r=>r.map(L=>`"${L}"`).join(",")).join(`
`)},q=(l,o)=>{const d=new Blob([l],{type:"text/csv;charset=utf-8;"}),i=document.createElement("a"),r=URL.createObjectURL(d);i.setAttribute("href",r),i.setAttribute("download",o),i.style.visibility="hidden",document.body.appendChild(i),i.click(),document.body.removeChild(i)};return{loading:U,error:v,users:u,totalUsers:x,currentPage:h,pageSize:m,searchQuery:C,sortField:p,sortDirection:A,selectedRole:S,totalPages:E,filteredUsers:D,paginatedUsers:R,fetchUsers:T,updateUserRole:Q,toggleUserStatus:H,deleteUser:W,searchUsers:X,filterByRole:Z,sortUsers:ee,goToPage:k,exportUsers:I}},Me={class:"user-management"},$e={class:"container"},Ne={class:"row"},Le={class:"col s12 m4"},Re={class:"input-field"},Te=["disabled"],Ie={class:"col s12 m3"},Be={class:"input-field"},Ve=["disabled"],Ke={class:"col s12 m3"},Fe={class:"input-field"},Pe=["disabled"],qe={class:"col s12 m2"},ze=["disabled"],je={class:"row"},Ye={class:"col s12 m3"},Oe={class:"card-panel center-align"},Ge={class:"blue-text"},Je={class:"col s12 m3"},Qe={class:"card-panel center-align"},He={class:"green-text"},We={class:"col s12 m3"},Xe={class:"card-panel center-align"},Ze={class:"orange-text"},et={class:"col s12 m3"},tt={class:"card-panel center-align"},st={class:"purple-text"},lt={key:0,class:"row"},at={key:1,class:"row"},ot={class:"col s12"},nt={class:"card-panel red lighten-4 red-text"},rt={key:2,class:"row"},it={class:"col s12"},dt={class:"card"},ct={class:"card-content"},ut={class:"card-title"},vt={class:"table-container"},mt={class:"striped responsive-table",role:"table","aria-label":"User management table","aria-describedby":"table-description"},gt={id:"table-description",class:"sr-only"},pt=["aria-label","aria-sort"],ft={class:"material-icons tiny","aria-hidden":"true"},yt=["aria-label","aria-sort"],bt={class:"material-icons tiny","aria-hidden":"true"},ht=["aria-label","aria-sort"],wt={class:"material-icons tiny","aria-hidden":"true"},Ut=["aria-label","aria-sort"],Ct={class:"material-icons tiny","aria-hidden":"true"},_t={class:"user-info"},At=["aria-label"],St=["onClick","onKeydown","aria-label"],xt=["onClick","onKeydown","aria-label"],Dt={class:"material-icons","aria-hidden":"true"},Et=["onClick","onKeydown","aria-label"],kt={key:0,class:"center-align grey-text",style:{padding:"2rem"}},Mt={key:0,class:"pagination-wrapper center-align"},$t={class:"pagination"},Nt=["onClick"],Lt={class:"grey-text"},Rt={id:"edit-user-modal",class:"modal"},Tt={class:"modal-content"},It={key:0},Bt={class:"input-field"},Vt={class:"input-field"},Kt={id:"delete-user-modal",class:"modal"},Ft={class:"modal-content"},Pt={key:0},qt={__name:"UserManagement",setup(U){const{loading:v,error:u,users:x,totalUsers:h,currentPage:m,pageSize:C,searchQuery:p,sortField:A,sortDirection:S,selectedRole:E,totalPages:D,filteredUsers:R,paginatedUsers:T,fetchUsers:Q,updateUserRole:H,toggleUserStatus:W,deleteUser:X,searchUsers:Z,filterByRole:ee,sortUsers:k,goToPage:I,exportUsers:F}=ke(),{announce:w,focusElement:P,trapFocus:q}=Ee(),l=b(null),o=b(null),d=N(()=>x.value.filter(a=>a.status==="Active").length),i=N(()=>x.value.filter(a=>a.role==="counsellor").length),r=N(()=>x.value.filter(a=>a.role==="youth").length),L=N(()=>{const a=[],t=Math.max(1,m.value-2),s=Math.min(D.value,m.value+2);for(let g=t;g<=s;g++)a.push(g);return a}),B=()=>{Z(p.value)},ve=()=>{ee(E.value)},me=()=>{m.value=1},z=a=>A.value!==a?"unfold_more":S.value==="asc"?"keyboard_arrow_up":"keyboard_arrow_down",ge=a=>({youth:"blue lighten-4 blue-text",counsellor:"green lighten-4 green-text",admin:"red lighten-4 red-text"})[a]||"grey lighten-4 grey-text",pe=a=>({Active:"green lighten-4 green-text",Inactive:"orange lighten-4 orange-text",Dormant:"red lighten-4 red-text"})[a]||"grey lighten-4 grey-text",fe=a=>a?new Date(a.seconds*1e3).toLocaleDateString():"Unknown",oe=a=>{l.value={...a},M.Modal.getInstance(document.getElementById("edit-user-modal")).open(),setTimeout(()=>{const s=document.getElementById("edit-user-modal");s&&(q(s),P("#edit-name"))},100),w(`Editing user ${a.displayName||a.email}`)},ye=async()=>{if(l.value)try{const a=await H(l.value.id,l.value.role);a.success?(M.toast({html:a.message,classes:"green"}),w(`User ${l.value.displayName||l.value.email} updated successfully`),M.Modal.getInstance(document.getElementById("edit-user-modal")).close()):(M.toast({html:a.message,classes:"red"}),w(`Error updating user: ${a.message}`))}catch(a){M.toast({html:"Error updating user: "+a.message,classes:"red"}),w(`Error updating user: ${a.message}`)}},ne=async a=>{try{const t=!a.isActive,s=await W(a.id,t);s.success?M.toast({html:`User ${t?"activated":"deactivated"} successfully`,classes:"green"}):M.toast({html:s.message,classes:"red"})}catch(t){M.toast({html:"Error updating user status: "+t.message,classes:"red"})}},re=a=>{o.value=a,M.Modal.getInstance(document.getElementById("delete-user-modal")).open(),setTimeout(()=>{const s=document.getElementById("delete-user-modal");s&&(q(s),P(".modal-footer .btn.red"))},100),w(`Confirm deletion of user ${a.displayName||a.email}`)},be=async()=>{if(o.value)try{const a=await X(o.value.id);a.success?(M.toast({html:a.message,classes:"green"}),M.Modal.getInstance(document.getElementById("delete-user-modal")).close(),o.value=null):M.toast({html:a.message,classes:"red"})}catch(a){M.toast({html:"Error deleting user: "+a.message,classes:"red"})}},he=()=>{try{const a=F();a.success?(M.toast({html:a.message,classes:"green"}),w("User data exported successfully")):(M.toast({html:a.message,classes:"red"}),w(`Export failed: ${a.message}`))}catch(a){M.toast({html:"Error exporting users: "+a.message,classes:"red"}),w(`Export error: ${a.message}`)}},j=(a,t)=>{if(a.key==="Enter"||a.key===" "){a.preventDefault(),k(t);const s=S.value==="asc"?"ascending":"descending";w(`Table sorted by ${t} in ${s} order`)}},te=(a,t)=>{(a.key==="Enter"||a.key===" ")&&(a.preventDefault(),t())},Y=a=>A.value!==a?"none":S.value==="asc"?"ascending":"descending",O=a=>A.value!==a?"none":S.value==="asc"?"ascending":"descending";return we(async()=>{typeof M<"u"&&setTimeout(()=>{M.FormSelect.init(document.querySelectorAll("select")),M.Modal.init(document.querySelectorAll(".modal"))},100),await Q()}),(a,t)=>(y(),f("div",Me,[e("div",$e,[t[41]||(t[41]=e("div",{"aria-live":"polite","aria-atomic":"true",class:"sr-only",id:"user-management-announcements"},null,-1)),t[42]||(t[42]=e("div",{class:"row"},[e("div",{class:"col s12"},[e("h4",null,"User Management"),e("p",{class:"grey-text"},"Manage platform users with advanced search and filtering")])],-1)),e("div",Ne,[e("div",Le,[e("div",Re,[t[15]||(t[15]=e("i",{class:"material-icons prefix"},"search",-1)),V(e("input",{id:"search",type:"text","onUpdate:modelValue":t[0]||(t[0]=s=>se(p)?p.value=s:null),onInput:B,disabled:n(v)},null,40,Te),[[ie,n(p)]]),t[16]||(t[16]=e("label",{for:"search"},"Search by name or email",-1))])]),e("div",Ie,[e("div",Be,[V(e("select",{"onUpdate:modelValue":t[1]||(t[1]=s=>se(E)?E.value=s:null),onChange:ve,disabled:n(v)},[...t[17]||(t[17]=[e("option",{value:""},"All Roles",-1),e("option",{value:"youth"},"Youth",-1),e("option",{value:"counsellor"},"Counsellor",-1),e("option",{value:"admin"},"Admin",-1)])],40,Ve),[[le,n(E)]]),t[18]||(t[18]=e("label",null,"Filter by Role",-1))])]),e("div",Ke,[e("div",Fe,[V(e("select",{"onUpdate:modelValue":t[2]||(t[2]=s=>se(C)?C.value=s:null),onChange:me,disabled:n(v)},[...t[19]||(t[19]=[e("option",{value:"5"},"5 per page",-1),e("option",{value:"10"},"10 per page",-1),e("option",{value:"25"},"25 per page",-1),e("option",{value:"50"},"50 per page",-1)])],40,Pe),[[le,n(C)]]),t[20]||(t[20]=e("label",null,"Items per page",-1))])]),e("div",qe,[e("button",{onClick:he,class:"btn waves-effect waves-light blue",disabled:n(v),style:{"margin-top":"1rem"}},[...t[21]||(t[21]=[e("i",{class:"material-icons left"},"file_download",-1),_(" Export ",-1)])],8,ze)])]),e("div",je,[e("div",Ye,[e("div",Oe,[e("h5",Ge,c(n(h)),1),t[22]||(t[22]=e("p",null,"Total Users",-1))])]),e("div",Je,[e("div",Qe,[e("h5",He,c(d.value),1),t[23]||(t[23]=e("p",null,"Active Users",-1))])]),e("div",We,[e("div",Xe,[e("h5",Ze,c(i.value),1),t[24]||(t[24]=e("p",null,"Counsellors",-1))])]),e("div",et,[e("div",tt,[e("h5",st,c(r.value),1),t[25]||(t[25]=e("p",null,"Youth Users",-1))])])]),n(v)?(y(),f("div",lt,[...t[26]||(t[26]=[Ue('<div class="col s12 center-align" data-v-51a1c2ce><div class="preloader-wrapper big active" data-v-51a1c2ce><div class="spinner-layer spinner-blue-only" data-v-51a1c2ce><div class="circle-clipper left" data-v-51a1c2ce><div class="circle" data-v-51a1c2ce></div></div><div class="gap-patch" data-v-51a1c2ce><div class="circle" data-v-51a1c2ce></div></div><div class="circle-clipper right" data-v-51a1c2ce><div class="circle" data-v-51a1c2ce></div></div></div></div><p data-v-51a1c2ce>Loading users...</p></div>',1)])])):$("",!0),n(u)?(y(),f("div",at,[e("div",ot,[e("div",nt,[t[27]||(t[27]=e("i",{class:"material-icons left"},"error",-1)),_(" Error loading users: "+c(n(u)),1)])])])):$("",!0),!n(v)&&!n(u)?(y(),f("div",rt,[e("div",it,[e("div",dt,[e("div",ct,[e("span",ut," Users ("+c(n(R).length)+" of "+c(n(h))+") ",1),e("div",vt,[e("table",mt,[e("caption",gt," Table showing "+c(n(h))+" users with sorting and filtering options. Currently showing "+c(n(T).length)+" users on page "+c(n(m))+" of "+c(n(D))+". ",1),e("thead",null,[e("tr",null,[e("th",null,[e("button",{type:"button",onClick:t[3]||(t[3]=s=>n(k)("displayName")),onKeydown:t[4]||(t[4]=s=>j(s,"displayName")),class:"sort-header","aria-label":`Sort by name ${Y("displayName")}`,"aria-sort":O("displayName")},[t[28]||(t[28]=_(" Name ",-1)),e("i",ft,c(z("displayName")),1)],40,pt)]),e("th",null,[e("button",{type:"button",onClick:t[5]||(t[5]=s=>n(k)("email")),onKeydown:t[6]||(t[6]=s=>j(s,"email")),class:"sort-header","aria-label":`Sort by email ${Y("email")}`,"aria-sort":O("email")},[t[29]||(t[29]=_(" Email ",-1)),e("i",bt,c(z("email")),1)],40,yt)]),e("th",null,[e("button",{type:"button",onClick:t[7]||(t[7]=s=>n(k)("role")),onKeydown:t[8]||(t[8]=s=>j(s,"role")),class:"sort-header","aria-label":`Sort by role ${Y("role")}`,"aria-sort":O("role")},[t[30]||(t[30]=_(" Role ",-1)),e("i",wt,c(z("role")),1)],40,ht)]),t[32]||(t[32]=e("th",null,"Status",-1)),e("th",null,[e("button",{type:"button",onClick:t[9]||(t[9]=s=>n(k)("createdAt")),onKeydown:t[10]||(t[10]=s=>j(s,"createdAt")),class:"sort-header","aria-label":`Sort by join date ${Y("createdAt")}`,"aria-sort":O("createdAt")},[t[31]||(t[31]=_(" Join Date ",-1)),e("i",Ct,c(z("createdAt")),1)],40,Ut)]),t[33]||(t[33]=e("th",null,"Last Active",-1)),t[34]||(t[34]=e("th",null,"Actions",-1))])]),e("tbody",null,[(y(!0),f(de,null,ce(n(T),s=>(y(),f("tr",{key:s.id},[e("td",null,[e("div",_t,[t[35]||(t[35]=e("i",{class:"material-icons left"},"account_circle",-1)),_(" "+c(s.displayName||"No Name"),1)])]),e("td",null,c(s.email),1),e("td",null,[e("span",{class:K(["chip",ge(s.role)])},c(s.role),3)]),e("td",null,[e("span",{class:K(["chip",pe(s.status)])},c(s.status),3)]),e("td",null,c(fe(s.createdAt)),1),e("td",null,c(s.lastActive),1),e("td",null,[e("div",{class:"action-buttons",role:"group","aria-label":`Actions for ${s.displayName||s.email}`},[e("button",{onClick:g=>oe(s),onKeydown:g=>te(g,()=>oe(s)),class:"btn-small blue waves-effect waves-light","aria-label":`Edit user ${s.displayName||s.email}`},[...t[36]||(t[36]=[e("i",{class:"material-icons","aria-hidden":"true"},"edit",-1)])],40,St),e("button",{onClick:g=>ne(s),onKeydown:g=>te(g,()=>ne(s)),class:"btn-small orange waves-effect waves-light","aria-label":`${s.isActive?"Deactivate":"Activate"} user ${s.displayName||s.email}`},[e("i",Dt,c(s.isActive?"block":"check_circle"),1)],40,xt),e("button",{onClick:g=>re(s),onKeydown:g=>te(g,()=>re(s)),class:"btn-small red waves-effect waves-light","aria-label":`Delete user ${s.displayName||s.email}`},[...t[37]||(t[37]=[e("i",{class:"material-icons","aria-hidden":"true"},"delete",-1)])],40,Et)],8,At)])]))),128))])]),n(T).length===0?(y(),f("div",kt,[...t[38]||(t[38]=[e("i",{class:"material-icons large"},"people_outline",-1),e("p",null,"No users found matching your criteria",-1)])])):$("",!0)]),n(D)>1?(y(),f("div",Mt,[e("ul",$t,[e("li",{class:K({disabled:n(m)===1})},[e("a",{onClick:t[11]||(t[11]=s=>n(I)(n(m)-1))},[...t[39]||(t[39]=[e("i",{class:"material-icons"},"chevron_left",-1)])])],2),(y(!0),f(de,null,ce(L.value,s=>(y(),f("li",{key:s,class:K({active:s===n(m)})},[e("a",{onClick:g=>n(I)(s)},c(s),9,Nt)],2))),128)),e("li",{class:K({disabled:n(m)===n(D)})},[e("a",{onClick:t[12]||(t[12]=s=>n(I)(n(m)+1))},[...t[40]||(t[40]=[e("i",{class:"material-icons"},"chevron_right",-1)])])],2)]),e("p",Lt," Showing "+c((n(m)-1)*n(C)+1)+" to "+c(Math.min(n(m)*n(C),n(R).length))+" of "+c(n(R).length)+" users ",1)])):$("",!0)])])])])):$("",!0)]),e("div",Rt,[e("div",Tt,[t[46]||(t[46]=e("h4",null,"Edit User",-1)),l.value?(y(),f("div",It,[e("div",Bt,[V(e("input",{id:"edit-name",type:"text","onUpdate:modelValue":t[13]||(t[13]=s=>l.value.displayName=s)},null,512),[[ie,l.value.displayName]]),t[43]||(t[43]=e("label",{for:"edit-name",class:"active"},"Display Name",-1))]),e("div",Vt,[V(e("select",{"onUpdate:modelValue":t[14]||(t[14]=s=>l.value.role=s)},[...t[44]||(t[44]=[e("option",{value:"youth"},"Youth",-1),e("option",{value:"counsellor"},"Counsellor",-1),e("option",{value:"admin"},"Admin",-1)])],512),[[le,l.value.role]]),t[45]||(t[45]=e("label",null,"Role",-1))])])):$("",!0)]),e("div",{class:"modal-footer"},[e("button",{onClick:ye,class:"btn blue waves-effect waves-light"}," Save Changes "),t[47]||(t[47]=e("button",{class:"modal-close btn-flat waves-effect waves-light"}," Cancel ",-1))])]),e("div",Kt,[e("div",Ft,[t[51]||(t[51]=e("h4",null,"Confirm Delete",-1)),t[52]||(t[52]=e("p",null,"Are you sure you want to delete this user? This action cannot be undone.",-1)),o.value?(y(),f("div",Pt,[e("p",null,[t[48]||(t[48]=e("strong",null,"Name:",-1)),_(" "+c(o.value.displayName),1)]),e("p",null,[t[49]||(t[49]=e("strong",null,"Email:",-1)),_(" "+c(o.value.email),1)]),e("p",null,[t[50]||(t[50]=e("strong",null,"Role:",-1)),_(" "+c(o.value.role),1)])])):$("",!0)]),e("div",{class:"modal-footer"},[e("button",{onClick:be,class:"btn red waves-effect waves-light"}," Delete User "),t[53]||(t[53]=e("button",{class:"modal-close btn-flat waves-effect waves-light"}," Cancel ",-1))])])]))}},Jt=De(qt,[["__scopeId","data-v-51a1c2ce"]]);export{Jt as default};
